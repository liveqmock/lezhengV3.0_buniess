<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>编辑行政审批</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">

    <link rel="stylesheet" href="../../plugins/layui/css/layui.css" media="all"/>
    <link rel="stylesheet" href="../../css/global.css" media="all">
    <link rel="stylesheet" href="../../plugins/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="../../css/table.css"/>
</head>

<body>
<div style="margin: 15px;">
    <fieldset class="layui-elem-field">
        <legend>新建订单</legend>

        <div class="layui-field-box">
            <div class="order-form-title" style="margin-top: 15px">用户信息</div>
            <table class="layui-table"
            <colgroup>
                <col width="100">
                <col>
            </colgroup>
            <tbody>
            <tr>
                <td colspan="2">
                    <div class="layui-input-inline">
                        <input type="text" name="title" lay-verify="required" autocomplete="off"
                               placeholder="请输入乐政号/电话号码搜索" class="layui-input self-form-input">

                    </div>
                    <button class="layui-btn" lay-submit="" lay-filter="searuser" style="margin:0!important">搜索</button>
                </td>
            </tr>
            <tr>
                <th class="self-form-title">乐政号：</th>
                <td>
                    <div class="layui-input-inline" id="lznumber">用户乐政号</div>
                </td>
            </tr>
            <tr>
                <th class="self-form-title">手机号：</th>
                <td>
                    <div class="layui-input-inline" id="phonenumer">用户手机号</div>
                </td>
            </tr>
            <tr>
                <th class="self-form-title">昵称：</th>
                <td>
                    <div class="layui-input-inline" id="nickname">用户昵称</div>
                </td>
            </tr>

            <tr>
                <th class="self-form-title">常驻地址:</th>
                <td>
                    <div class="layui-input-inline" id="address">用户常驻地址</div>
                </td>
            </tr>
            </tbody>
            </table>
        </div>
        <div class="layui-field-box">
            <form class="layui-form" action="" id="orderQuery">
                <div class="order-form-title">编辑订单</div>
                <table class="layui-table">
                    <tr>
                        <th class="self-form-title">订单类型：</th>
                        <td>
                            <div class="layui-input-inline">
                                <div class="layui-input-inline">
                                    <select name="ordertype" lay-verify="required">
                                        <option value="">—— 请选择 ——</option>
                                        <option value="0">政务审批</option>
                                        <option value="1">第三方服务</option>
                                        <option value="2">企业服务</option>
                                    </select>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr style="background-color:#f2f2f2">
                        <td colspan="2">
                            <div class="order-form-title">基本信息</div>
                        </td>
                    </tr>
                    <tr>
                        <th class="self-form-title">预约客户：</th>
                        <td>
                            <div class="layui-input-inline">
                                <input type="text" name="username" lay-verify="required" autocomplete="off"
                                       placeholder="请输入预约客户" class="layui-input self-form-input">
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th class="self-form-title">手机号码：</th>
                        <td>
                            <div class="layui-input-inline">
                                <input type="text" name="uphonenumber" maxlength="11" lay-verify="required"
                                       autocomplete="off"
                                       placeholder="请输入客户手机号码" class="layui-input self-form-input">
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th class="self-form-title">办事区域：</th>
                        <td>
                            <div class="layui-input-inline area">
                                <select name="officearea" lay-verify="required">
                                    <option value="">— 请选择办事区域 —</option>
                                </select>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th class="self-form-title">详细地址：</th>
                        <td>
                            <div class="layui-input-inline">
                                <div class="layui-input-inline">
                                    <input type="text" name="officeaddress" lay-verify="required" autocomplete="off"
                                           placeholder="请输入详细地址" class="layui-input self-form-input">
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr style="background-color:#f2f2f2">
                        <td colspan="2">
                            <div class="order-form-title">收件人信息</div>
                        </td>
                    </tr>
                    <tr>
                        <th class="self-form-title">收件人：</th>
                        <td>
                            <div class="layui-input-inline">
                                <div class="layui-input-inline">
                                    <input type="text" name="addressee" lay-verify="required" autocomplete="off"
                                           placeholder="请输入收件人" class="layui-input self-form-input">
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th class="self-form-title">手机号码：</th>
                        <td>
                            <div class="layui-input-inline">
                                <div class="layui-input-inline" id="fixedstep">
                                    <input type="text" name="aphonenumber" maxlength="11" lay-verify="required"
                                           autocomplete="off"
                                           placeholder="请输入收件人手机号码" class="layui-input self-form-input">
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th class="self-form-title">收件区域：</th>
                        <td>
                            <div class="layui-input-inline area">
                                <select name="inboxarea" lay-verify="required">
                                    <option value="">— 请选择收件区域 —</option>
                                </select>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th class="detail-title">详细地址：</th>
                        <td>
                            <div class="layui-input-block edit_box self-edit-margin">
                                <input type="text" name="inboxaddress" lay-verify="required" autocomplete="off"
                                       placeholder="请输入详细地址" class="layui-input self-form-input">
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th class="self-form-title">留言：</th>
                        <td>
                            <div class="layui-input-inline">
                                 <textarea placeholder="选填，请留下用户的特殊情况" name="remarks" class="layui-textarea"
                                           style="width: 300px"></textarea>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th class="self-form-title">受理商家：</th>
                        <td>
                            <div class="layui-input-inline">
                                <input type="text" name="marketername" lay-verify="" autocomplete="off"
                                       placeholder="请选择受理商家" class="layui-input self-form-input chooseStore">

                            </div>
                        </td>
                    </tr>
                </table>
                <div class="layui-btn-group self-btn-return">
                    <button class="layui-btn" lay-submit="" lay-filter="submit">提交</button>
                    <button class="layui-btn layui-btn-primary" type="reset" lay-filter="reset">重置</button>
                </div>
            </form>

        </div>
    </fieldset>
</div>

<script id="orderHandle" type="text/html">
    <tr>
        <th>事项名称：</th>
        <td>{{ d.title}}</td>
    </tr>
    <tr>
        <th>事项编号：</th>
        <td>{{ d.id}}</td>
    </tr>
    <tr>
        <th>服务主题：</th>
        <td>建筑类</td>
    </tr>
    <tr>
        <th>订单步骤：</th>
        <td>订单步骤一</td>
    </tr>
</script>

<script type="text/javascript" src="../../plugins/layui/layui.js"></script>
<script type="text/javascript" src="../../js/config.js"></script>

<script>
    layui.use(['form', 'layedit', 'laydate', 'element', 'icheck', 'laypage', 'layer', 'laytpl', 'common', 'formInStorage'], function () {
        var form = layui.form(),
                layer = layui.layer,
                layedit = layui.layedit,
                laydate = layui.laydate,
                $ = layui.jquery,
                laytpl = layui.laytpl,
                element = layui.element(), //Tab的切换功能，切换事件监听等，需要依赖element模块
                laypage = layui.laypage,
                common = layui.common,
                formInStorage = layui.formInStorage,
                apiUrl = common.apiUrl,
                editIndex = layedit.build('LAY_demo_editor'), //创建一个编辑器
                serviceIndex = localStorage.getItem('serviceIndex'),
                orderID = common.getUrlParam("id"),
                layer = layui.layer;
        common.saveTabIndex('serviceIndex');
        common.init();
        common.layTime(); //时间选择
        //复选框样式
        $('input').iCheck({
            checkboxClass: 'icheckbox_flat-green'
        });


        //区域下拉列表
        var dataArr = {"id": 0};
        var areaBig = common.getJsonData('api/bossApi/service/areaSearch', '', dataArr);
        $.each(areaBig.datalist, function (index, item) {
            $(".area select").append('<optgroup label="' + item.areaname + '" oid="' + item.areacode + '"></optgroup>');
            var dataArr = {"id": item.areacode};
            var areaSmall = common.getJsonData('api/bossApi/service/areaSearch', '', dataArr);
            for (var i = 0; i < areaSmall.datalist.length; i++) {
                $("optgroup[oid='" + item.areaid + "']").append('<option value="' + areaSmall.datalist[i].areaid + '">' + areaSmall.datalist[i].areaname + '</option>');
            }
        });
        form.render();

        //避免input被刷新清空
        formInStorage.init({
            formElem: '#orderQuery',
            formSession: 'orderQuery'
        });

        $(document).on('click', '.chooseStore', function () {
            layer.open({
                type: 2,
                title: '选择受理商家',
                shadeClose: true,
                shade: 0.8,
                area: ['1200px', '90%'],
                content: '../ordersHandle/allot.html'
            });
        })

        //给受理商家input赋值
        var marketername = sessionStorage.getItem("marketername");
        var marketerid = sessionStorage.getItem("marketerid");
        if (marketername) {
            $('input[name="marketername"]').attr('placeholder', marketername);
        }

        //监听提交
        form.on('submit(submit)', function (data) {
            var dataArr = {
                "orderid": 0,
                "uid": 1,
                "ordersource": 1,
                "ordertype": data.field.ordertype,
                "username": data.field.username,
                "uphonenumber": data.field.uphonenumber,
                "officearea": data.field.officearea,
                "officeaddress": data.field.officeaddress,
                "addressee": data.field.addressee,
                "aphonenumber": data.field.aphonenumber,
                "inboxarea": data.field.inboxarea,
                "inboxaddress": data.field.inboxaddress,
                "remarks": data.field.remarks,
                "marketerid": marketerid,
                "marketername": marketername
            };
            var getJSON = common.getJsonData('api/bossApi/order/ordersEdit', '', dataArr);
            //console.log(dataArr);
            // console.log(getJSON);
            // return false;
            if (getJSON["code"] == 1) {
                layer.msg('操作成功', {icon: 1, time: 1500}, function () {
                    localStorage.removeItem("orderQuery");
                    sessionStorage.removeItem("marketerid");
                    sessionStorage.removeItem("marketername");
                    history.go(-1);
                    /*
                    var index = parent.layer.getFrameIndex(window.name);
                    parent.layer.close(index);
                    window.parent.location.reload();
                    */
                });
            } else {
                layer.msg(getJSON["msg"], {icon: 2, time: 1500}, function () {
                    history.go(-1);
                });
            }
            return false;
        });

        //搜索用户信息
        form.on('submit(searuser)', function (data) {
            var dataArr = {
                "text": $('input[name="title"]').val(),
                "page": 1
            }
            var getJSON = common.getJsonData('api/bossApi/order/ordersUserSearch', '', dataArr);
            if (getJSON.datalist[0]) {
                $("#lznumber").html(getJSON.datalist[0].lznumber);
                $("#phonenumer").html(getJSON.datalist[0].phonenumer);
                $("#nickname").html(getJSON.datalist[0].nickname);
                $("#address").html(getJSON.datalist[0].address);
            }else{
                layer.msg('不存在该用户');
            }
            //console.log(getJSON.datalist[0]);
        });

    });
</script>
</body>
</html>
